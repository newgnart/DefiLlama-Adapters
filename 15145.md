Issue [#15145](https://github.com/DefiLlama/DefiLlama-Adapters/issues/15145)
> for non-evm chains that rpc-agg supports, use that
> update current sui/starknet/... chain helper code to first try requesting rpc-agg and then fallback to chain rpc if it fails.
> related discussion: https://discord.com/channels/823822164956151810/994600371529973870/1385184821596393574




# 1. Files to MODIFY (Existing)
## projects/helper/chain/rpcProxy.js
 ⭐ MAIN MODIFICATION

 ```js
 // ADD new starknet section
starknet: {
  call: async ({ abi, target, params = [], allAbi = [], permitFailure = false }) => {
    const { data } = await client.post('/starknet/call', { 
      abi, target, params, allAbi, permitFailure 
    })
    return data
  },
  multiCall: async ({ abi, target, calls = [], allAbi = [], permitFailure = false }) => {
    const { data } = await client.post('/starknet/multiCall', { 
      abi, target, calls, allAbi, permitFailure 
    })
    return data
  },
  getEvents: async ({ fromBlock, topic, target }) => {
    const { data } = await client.post('/starknet/getEvents', { 
      fromBlock, topic, target 
    })
    return data
  }
}
```
## projects/helper/chain/starknet.js 
⭐ MAIN MODIFICATION

 ```js
 // ADD rpc-agg integration with fallback
const rpcProxy = require('./rpcProxy')

async function callWithFallback({ abi, target, params = [], allAbi = [], permitFailure = false } = {}) {
  try {
    // Try rpc-agg first
    return await rpcProxy.starknet.call({ abi, target, params, allAbi, permitFailure })
  } catch (error) {
    // Fallback to direct RPC
    const { data } = await axios.post(STARKNET_RPC, formCallBody({ abi, target, params, allAbi }))
    return parseOutput(data.result, abi, allAbi, { permitFailure, responseObj: data })
  }
}

async function multiCallWithFallback({ abi: rootAbi, target: rootTarget, calls = [], allAbi = [], permitFailure = false }) {
  try {
    // Try rpc-agg first
    return await rpcProxy.starknet.multiCall({ abi: rootAbi, target: rootTarget, calls, allAbi, permitFailure })
  } catch (error) {
    // Fallback to direct RPC (existing implementation)
    // ... existing multiCall logic
  }
}

// UPDATE module.exports to use new functions
module.exports = {
  call: rateLimited(callWithFallback),        // CHANGED
  multiCall: rateLimited(multiCallWithFallback), // CHANGED
  parseAddress: validateAndParseAddress,
  sumTokens: rateLimited(sumTokens),
  number,
  dexExport,
}
 ```
## projects/helper/env.js

 ```js
 // ADD new environment variable (optional, for configuration)
STARKNET_RPC_AGG_ENABLED: true,  // NEW
```

# 2. Files to ADD (New)
## projects/helper/chain/starknet-rpc-agg.js
⭐ NEW FILE

```js
// Dedicated rpc-agg integration for Starknet
const rpcProxy = require('./rpcProxy')
const { formCallBody, parseOutput } = require('./starknet')

class StarknetRpcAgg {
  async call({ abi, target, params = [], allAbi = [], permitFailure = false }) {
    try {
      return await rpcProxy.starknet.call({ abi, target, params, allAbi, permitFailure })
    } catch (error) {
      throw new Error(`Starknet rpc-agg call failed: ${error.message}`)
    }
  }

  async multiCall({ abi: rootAbi, target: rootTarget, calls = [], allAbi = [], permitFailure = false }) {
    try {
      return await rpcProxy.starknet.multiCall({ abi: rootAbi, target: rootTarget, calls, allAbi, permitFailure })
    } catch (error) {
      throw new Error(`Starknet rpc-agg multiCall failed: ${error.message}`)
    }
  }

  async getEvents({ fromBlock, topic, target }) {
    try {
      return await rpcProxy.starknet.getEvents({ fromBlock, topic, target })
    } catch (error) {
      throw new Error(`Starknet rpc-agg getEvents failed: ${error.message}`)
    }
  }
}

module.exports = new StarknetRpcAgg()
```
## projects/helper/chain/starknet-fallback.js
⭐ NEW FILE

```js
// Fallback mechanism for Starknet RPC calls
const axios = require('axios')
const { getEnv } = require('../env')
const { formCallBody, parseOutput } = require('./starknet')

const STARKNET_RPC = getEnv('STARKNET_RPC')

class StarknetFallback {
  async call({ abi, target, params = [], allAbi = [], permitFailure = false }) {
    const { data } = await axios.post(STARKNET_RPC, formCallBody({ abi, target, params, allAbi }))
    return parseOutput(data.result, abi, allAbi, { permitFailure, responseObj: data })
  }

  async multiCall({ abi: rootAbi, target: rootTarget, calls = [], allAbi = [], permitFailure = false }) {
    // ... existing multiCall implementation
  }

  async getEvents({ fromBlock, topic, target }) {
    // ... existing getEvents implementation
  }
}

module.exports = new StarknetFallback()
```

# 3. Files that will AUTOMATICALLY BENEFIT 
(No changes needed)
These protocols will automatically get rpc-agg benefits once the chain helper is updated:
projects/zklend/index.js - Uses multiCall, sumTokens, call
projects/zklend-strk-staking/index.js - Uses call
projects/vesu/index.js - Uses multiCall, sumTokens
projects/whales-market/index.js - Uses Starknet TVL
projects/xfamtech/index.js - Uses Starknet TVL
Any other protocols using Starknet chain helper


# 4. Test
## test/starknet-rpc-agg.test.js 
⭐ NEW FILE

```js
// Test rpc-agg integration and fallback
const { call, multiCall } = require('../projects/helper/chain/starknet')

describe('Starknet rpc-agg Integration', () => {
  test('should use rpc-agg for successful calls', async () => {
    // Test successful rpc-agg call
  })

  test('should fallback to direct RPC when rpc-agg fails', async () => {
    // Test fallback mechanism
  })

  test('should handle multiCall with rpc-agg', async () => {
    // Test multiCall integration
  })
})
```

# 5. Documentation
## docs/starknet-rpc-agg.md 
⭐ NEW FILE

```md
# Starknet rpc-agg Integration

## Overview
This document describes the rpc-agg integration for Starknet chain helper.

## Implementation
- Primary: rpc-agg service
- Fallback: Direct Starknet RPC

## Usage
No changes needed in protocol adapters - automatic integration.
```